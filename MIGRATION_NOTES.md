# Migration Notes: Multi-Host Flake Setup

## Summary of Changes

Your NixOS configuration has been refactored into a proper multi-host Nix Flake setup with the following changes:

### Files Modified:
- ✅ `flake.nix` - Complete rewrite with proper inputs and home-manager integration
- ✅ `hosts/desktop/configuration.nix` - Simplified to host-specific settings only
- ✅ `hosts/laptop/configuration.nix` - Simplified to host-specific settings only

### Files Created:
- ✅ `hosts/common.nix` - New shared configuration module
- ✅ `FLAKE_USAGE.md` - Usage documentation
- ✅ `MIGRATION_NOTES.md` - This file

### Files Unchanged:
- ✅ `home/default.nix` - Works as-is with the new setup
- ✅ All home/ subdirectories and configurations
- ✅ Hardware configuration files (not modified)

## Before First Build

### 1. Generate flake.lock
You must run this command first to lock the flake inputs:
```bash
cd /home/flavio/Desktop/dotfiles
nix flake update
```

This will:
- Download and lock nixpkgs to the 25.05 release
- Download and lock home-manager to release-25.05
- Create the `flake.lock` file

### 2. Review host-specific settings
Check if there are any differences you want between desktop and laptop:
- The current setup assumes they're mostly identical
- Desktop has the HDD mount configured
- Laptop configuration is ready for laptop-specific settings (battery, power management, etc.)

## Building the Configuration

### Desktop:
```bash
sudo nixos-rebuild switch --flake .#desktop
```

### Laptop:
```bash
sudo nixos-rebuild switch --flake .#laptop
```

## Important Notes

### Home Manager Integration
- **OLD**: Used `builtins.fetchTarball` (impure) directly in configuration.nix
- **NEW**: Uses flake input (pure) defined in flake.nix
- The home-manager configuration (`home/default.nix`) remains unchanged and works with the new setup

### Hostname Configuration
- Desktop hostname is now set to "desktop" (was "nixos")
- Laptop hostname is now set to "laptop" (was "nixos")
- If you need to keep "nixos" as the hostname, edit the respective configuration file

### Hardware Configuration
- Both hosts still reference their local `hardware-configuration.nix`
- These files are not included in the repository but must exist on each machine
- They're generated by NixOS installation and contain hardware-specific settings

### Common Configuration Benefits
- All shared settings are now in one place: `hosts/common.nix`
- Changes to common settings automatically apply to all hosts
- Reduces maintenance burden and prevents configuration drift

## Potential Issues to Watch For

### 1. Hardware Configuration Files
Make sure these files exist:
- `/home/flavio/Desktop/dotfiles/hosts/desktop/hardware-configuration.nix`
- `/home/flavio/Desktop/dotfiles/hosts/laptop/hardware-configuration.nix`

### 2. Laptop-Specific HDD Mount
The desktop configuration includes an HDD mount to `/mnt/hdd`. If this same drive exists on the laptop and you want it mounted, you can either:
- Add it to `hosts/common.nix` (if both machines have it)
- Add it to `hosts/laptop/configuration.nix` (if laptop-specific)
- Leave it desktop-only (current setup)

### 3. First Build Time
The first build after migration will:
- Download all flake inputs
- May rebuild some packages due to the switch from fetchTarball to flake inputs
- Could take longer than usual updates

### 4. Git Considerations
If you track this repository in git:
- Add `flake.lock` to git (recommended for reproducibility)
- Consider adding `.direnv/` to `.gitignore` if using direnv
- The `result` symlink created by builds should be in `.gitignore`

## Rollback Plan

If you need to rollback to the old configuration:
- The old configuration files can be reconstructed from git history
- Or you can use NixOS generations: `sudo nixos-rebuild switch --rollback`
- Each successful build creates a new generation that can be booted into

## Testing Recommendations

### Before Switching:
1. Test the flake syntax:
   ```bash
   nix flake check
   ```

2. Build without switching:
   ```bash
   sudo nixos-rebuild build --flake .#desktop
   ```

3. Test without making it the boot default:
   ```bash
   sudo nixos-rebuild test --flake .#desktop
   ```

4. Only after successful testing:
   ```bash
   sudo nixos-rebuild switch --flake .#desktop
   ```

## Benefits of This Setup

1. **Reproducibility**: Locked inputs ensure consistent builds across machines
2. **Maintainability**: Shared configuration in one place
3. **Scalability**: Easy to add new hosts
4. **Purity**: No impure fetchTarball calls
5. **Best Practices**: Follows modern Nix Flakes patterns
6. **Flexibility**: Easy to override common settings per-host

## Need Help?

- Check `FLAKE_USAGE.md` for common commands
- Review NixOS manual: https://nixos.org/manual/nixos/stable/
- Check Flakes documentation: https://nixos.wiki/wiki/Flakes
- Home Manager manual: https://nix-community.github.io/home-manager/
